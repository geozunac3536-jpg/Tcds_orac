<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TCDS ‚Äî Reloj Causal Tesseract</title>
  <meta name="description" content="Reloj Causal TCDS: tiempo normal vs tiempo causal, coherencia Œ£ y veto entr√≥pico en vivo, visualizado como un tesseract hiperdimensional con controles de rotaci√≥n." />
  <meta name="theme-color" content="#070a10" />

  <style>
    :root{
      --bg:#06070b;
      --bg2:#0b1020;
      --txt:#eaf0ff;
      --mut: rgba(234,240,255,.72);
      --dim: rgba(234,240,255,.55);
      --stroke: rgba(255,255,255,.12);
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.035);
      --accent:#77a6ff;
      --a2:#91ffe0;
      --warn:#ffd37a;
      --ok:#8effa1;
      --bad:#ff7aa2;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --r: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family:var(--sans);
      background:
        radial-gradient(1200px 900px at 12% -12%, rgba(119,166,255,.22), transparent 60%),
        radial-gradient(1100px 800px at 88% 8%, rgba(145,255,224,.16), transparent 58%),
        radial-gradient(900px 700px at 55% 112%, rgba(255,122,162,.10), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:34px 18px 90px}

    header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;
      padding:18px 18px;
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .brand{display:flex;gap:14px;align-items:center}
    .sig{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(119,166,255,.95), rgba(145,255,224,.55) 44%, rgba(255,255,255,.07) 72%);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 0 7px rgba(119,166,255,.08);
      position:relative;
    }
    .sig:after{
      content:"";
      position:absolute;inset:-22px;
      background: radial-gradient(circle, rgba(119,166,255,.12), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
    }

    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--mut);font-size:13px;line-height:1.35}

    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      display:inline-flex;gap:8px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color:var(--txt);text-decoration:none;font-size:13px;
      transition: transform .15s ease, background .15s ease, border .15s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px);background: rgba(255,255,255,.07);border-color: rgba(255,255,255,.22)}
    .btn .dot{width:8px;height:8px;border-radius:99px;background:var(--accent)}
    .btn.small{padding:8px 10px;border-radius:999px;font-family:var(--mono);font-size:12px}

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      align-items:stretch;
    }
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column;align-items:stretch}
      .nav{justify-content:flex-start}
    }

    .card{
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .clockWrap{
      position:relative;
      min-height:520px;
    }
    @media(max-width:980px){
      .clockWrap{min-height:520px}
    }

    canvas#clock{
      width:100%;
      height:100%;
      display:block;
    }

    .overlay{
      position:absolute;inset:0;
      pointer-events:none;
      padding:18px;
      display:flex;flex-direction:column;justify-content:space-between;
    }

    .kicker{
      pointer-events:none;
      display:inline-flex;gap:10px;align-items:center;
      font-family:var(--mono);font-size:12px;color:var(--dim);
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      width:max-content;
    }
    .kicker .pulse{
      width:10px;height:10px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, var(--a2), rgba(145,255,224,.2) 60%, transparent 72%);
      box-shadow: 0 0 0 7px rgba(145,255,224,.08);
    }

    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    @media(max-width:620px){ .hud{grid-template-columns:1fr} }

    .panel{
      pointer-events:auto;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }

    .row{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .lab{font-family:var(--mono);font-size:12px;color:var(--dim)}
    .val{font-family:var(--mono);font-size:12px;color:var(--txt)}
    .big{
      margin-top:8px;
      font-size:28px;
      letter-spacing:.2px;
      font-weight:650;
      font-family:var(--mono);
    }
    .badge{
      display:inline-flex;gap:8px;align-items:center;
      font-family:var(--mono);font-size:12px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      margin-top:10px;
      width:max-content;
    }
    .badge .s{width:9px;height:9px;border-radius:99px;background:var(--ok)}
    .badge.warn .s{background:var(--warn)}
    .badge.bad .s{background:var(--bad)}

    .side{
      padding:16px;
    }

    .side h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
      color:rgba(234,240,255,.92);
    }

    .side h3{
      margin:0 0 6px;
      font-size:13px;
      color:var(--mut);
    }

    .tiles{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .tile{
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }
    .tile p{margin:0;color:var(--mut);font-size:13px;line-height:1.5}
    .tagrow{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .tag{
      font-family:var(--mono);
      font-size:12px;color:rgba(234,240,255,.76);
      padding:7px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }

    .controls{
      display:flex;gap:10px;flex-wrap:wrap;
      margin-top:12px;
    }
    .switch{
      pointer-events:auto;
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      font-family:var(--mono);font-size:12px;color:rgba(234,240,255,.8);
      user-select:none;
      cursor:pointer;
    }
    .knob{
      width:38px;height:20px;border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      position:relative;
    }
    .knob:after{
      content:"";
      position:absolute;top:1px;left:2px;
      width:16px;height:16px;border-radius:99px;
      background: rgba(234,240,255,.85);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      transition: transform .18s ease, background .18s ease;
    }
    .switch.on .knob{background: rgba(145,255,224,.15);border-color: rgba(145,255,224,.26)}
    .switch.on .knob:after{transform: translateX(18px);background: rgba(145,255,224,.9)}

    .slider{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-family:var(--mono);
      font-size:12px;
      color:var(--dim);
    }
    .slider input[type="range"]{
      width:100%;
      accent-color:var(--a2);
    }
    .slider .val{
      color:var(--txt);
      text-align:right;
    }

    .log{
      margin-top:12px;
      font-family:var(--mono);
      font-size:12px;
      color:rgba(234,240,255,.75);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:12px;
      max-height:210px;
      overflow:auto;
      line-height:1.55;
    }
    .log .ok{color:rgba(142,255,161,.95)}
    .log .bad{color:rgba(255,122,162,.95)}
    .log .warn{color:rgba(255,211,122,.95)}

    footer{
      margin-top:16px;
      color:var(--dim);
      font-size:12px;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;
    }
    .sep{opacity:.35}
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="brand">
        <div class="sig" aria-hidden="true"></div>
        <div>
          <h1>TCDS ‚Äî Reloj Causal Tesseract</h1>
          <div class="sub">Tiempo normal <span class="sep">¬∑</span> Tiempo causal <span class="sep">¬∑</span> coherencia Œ£ y veto entr√≥pico (ŒîH) en vivo, proyectado en hiperespacio</div>
        </div>
      </div>

      <nav class="nav">
        <a class="btn" href="./"><span class="dot"></span>Home</a>
        <a class="btn" href="./docs/"><span class="dot" style="background:var(--a2)"></span>Docs</a>
        <a class="btn" href="https://github.com/geozunac3536-jpg" target="_blank" rel="noopener">
          <span class="dot" style="background:var(--warn)"></span>GitHub
        </a>
        <a class="btn" href="mailto:genarocarrasco.ozuna@gmail.com"><span class="dot" style="background:var(--ok)"></span>Contacto</a>
      </nav>
    </header>

    <div class="grid">

      <!-- CLOCK -->
      <section class="card clockWrap">
        <canvas id="clock"></canvas>

        <div class="overlay">
          <div class="kicker"><span class="pulse"></span> Q¬∑Œ£ = œÜ ¬∑ reloj causal con proyecci√≥n tesseract hiperdimensional</div>

          <div class="hud">
            <div class="panel">
              <div class="row">
                <div class="lab">tM (tiempo est√°ndar)</div>
                <div class="val" id="tmLabel">‚Äî</div>
              </div>
              <div class="big" id="tmBig">--:--:--</div>
              <div class="badge" id="stateBadge"><span class="s"></span><span id="stateText">ESCANEO</span></div>
            </div>

            <div class="panel">
              <div class="row">
                <div class="lab">tC (tiempo causal)</div>
                <div class="val" id="tcLabel">dŒ£/dt</div>
              </div>
              <div class="big" id="tcBig">0.000</div>
              <div class="row" style="margin-top:6px">
                <div class="lab">LI</div><div class="val" id="liVal">0.000</div>
              </div>
              <div class="row">
                <div class="lab">R</div><div class="val" id="rVal">0.000</div>
              </div>
              <div class="row">
                <div class="lab">ŒîH</div><div class="val" id="dhVal">0.000</div>
              </div>
              <div class="row">
                <div class="lab">E-Veto</div><div class="val" id="vetoVal">‚Äî</div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- SIDE -->
      <aside class="card side">
        <h2>Panel de Control</h2>

        <div class="tiles">
          <div class="tile">
            <p>
              Esto es un <b>front-end</b> del Reloj Causal con visualizaci√≥n tesseract. Ahora est√° en modo
              <b>simulaci√≥n hiperdimensional</b> (para v√©rtigo 4D). Lo puedes cablear a:
              <span class="tagrow">
                <span class="tag">outbox/*.json</span>
                <span class="tag">events_feed.jsonl</span>
                <span class="tag">oracle_decisions</span>
              </span>
            </p>

            <div class="controls">
              <div class="switch on" id="swWarp"><div class="knob"></div>WARP 4D</div>
              <div class="switch on" id="swParticles"><div class="knob"></div>PART√çCULAS</div>
              <div class="switch on" id="swAuto"><div class="knob"></div>AUTO-ESCANEO</div>
              <a class="btn small" id="btnShock" href="javascript:void(0)"><span class="dot" style="background:var(--bad)"></span>INJECT LOCK</a>
              <a class="btn small" id="btnCalm" href="javascript:void(0)"><span class="dot" style="background:var(--a2)"></span>CALMA</a>
            </div>
          </div>

          <div class="tile">
            <h3>Controles de Rotaci√≥n</h3>
            <div class="slider">
              <label>Velocidad XW: <span class="val" id="speedXWVal">0.0005</span></label>
              <input type="range" id="speedXW" min="-0.002" max="0.002" step="0.0001" value="0.0005">
            </div>
            <div class="slider">
              <label>Velocidad YW: <span class="val" id="speedYWVal">0.0011</span></label>
              <input type="range" id="speedYW" min="-0.002" max="0.002" step="0.0001" value="0.0011">
            </div>
            <div class="slider">
              <label>Velocidad ZW: <span class="val" id="speedZWVal">0.0012</span></label>
              <input type="range" id="speedZW" min="-0.002" max="0.002" step="0.0001" value="0.0012">
            </div>
            <a class="btn small" id="btnResetRot" href="javascript:void(0)"><span class="dot" style="background:var(--warn)"></span>RESET ROT</a>
          </div>

          <div class="tile">
            <h2 style="margin:0 0 10px;font-size:14px">Registro</h2>
            <div class="log" id="log"></div>
          </div>

          <div class="tile">
            <p>
              <b>Lectura:</b> tC no es ‚Äúotra hora‚Äù; es un <b>gradiente</b> (dŒ£/dt).
              Cuando el sistema entra en locking y ŒîH cae, el tesseract <b>rota y distorsiona</b>:
              el futuro deja de ser conjetura y se vuelve geometr√≠a hiperoperable.
            </p>
          </div>
        </div>

        <footer>
          <div>¬© TCDS ‚Äî Cromodin√°mica Sincr√≥nica</div>
          <div class="sep">‚Äî</div>
          <div style="font-family:var(--mono)">Genaro Carrasco Ozuna ¬∑ MX</div>
        </footer>

      </aside>
    </div>

  </div>

<script>
/* ============================================================
   TCDS CAUSAL CLOCK ‚Äî ‚ÄúTESERACTO HIPERDIMENSIONAL V√âRTIGO‚Äù
   - Canvas: proyecci√≥n rotante de tesseract + warp + particles
   - Live HUD: tM, tC, LI, R, dH, E-Veto
   - Simulation baseline (cableable a datos reales)
   - Controles de rotaci√≥n a√±adidos
   ============================================================ */

const canvas = document.getElementById('clock');
const ctx = canvas.getContext('2d', { alpha: true });

const ui = {
  tmLabel: document.getElementById('tmLabel'),
  tmBig: document.getElementById('tmBig'),
  tcBig: document.getElementById('tcBig'),
  liVal: document.getElementById('liVal'),
  rVal: document.getElementById('rVal'),
  dhVal: document.getElementById('dhVal'),
  vetoVal: document.getElementById('vetoVal'),
  badge: document.getElementById('stateBadge'),
  stateText: document.getElementById('stateText'),
  log: document.getElementById('log'),
  speedXWVal: document.getElementById('speedXWVal'),
  speedYWVal: document.getElementById('speedYWVal'),
  speedZWVal: document.getElementById('speedZWVal')
};

let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function resize(){
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * DPR);
  canvas.height = Math.floor(rect.height * DPR);
}
window.addEventListener('resize', () => { resize(); });
resize();

// --------- Toggles
const toggles = {
  warp: true,
  particles: true,
  auto: true
};
function bindSwitch(id, key){
  const el = document.getElementById(id);
  el.addEventListener('click', () => {
    toggles[key] = !toggles[key];
    el.classList.toggle('on', toggles[key]);
    logLine(`‚öôÔ∏è ${key.toUpperCase()} = ${toggles[key] ? 'ON' : 'OFF'}`, 'warn');
  });
}
bindSwitch('swWarp','warp');
bindSwitch('swParticles','particles');
bindSwitch('swAuto','auto');

// --------- Rotation controls
let rotationSpeeds = {
  xw: 0.0005,
  yw: 0.0011,
  zw: 0.0012
};

function bindSlider(id, key, valEl){
  const slider = document.getElementById(id);
  slider.addEventListener('input', () => {
    rotationSpeeds[key] = parseFloat(slider.value);
    valEl.textContent = rotationSpeeds[key].toFixed(4);
    logLine(`üîÑ ${key.toUpperCase()} speed set to ${rotationSpeeds[key].toFixed(4)}`, 'warn');
  });
}
bindSlider('speedXW', 'xw', ui.speedXWVal);
bindSlider('speedYW', 'yw', ui.speedYWVal);
bindSlider('speedZW', 'zw', ui.speedZWVal);

document.getElementById('btnResetRot').addEventListener('click', () => {
  rotationSpeeds = { xw: 0.0005, yw: 0.0011, zw: 0.0012 };
  document.getElementById('speedXW').value = rotationSpeeds.xw;
  document.getElementById('speedYW').value = rotationSpeeds.yw;
  document.getElementById('speedZW').value = rotationSpeeds.zw;
  ui.speedXWVal.textContent = rotationSpeeds.xw.toFixed(4);
  ui.speedYWVal.textContent = rotationSpeeds.yw.toFixed(4);
  ui.speedZWVal.textContent = rotationSpeeds.zw.toFixed(4);
  logLine('üîÑ Rotation speeds reset', 'ok');
});

// --------- Log
function logLine(text, klass=''){
  const t = new Date().toLocaleTimeString();
  const span = document.createElement('div');
  span.innerHTML = `<span style="opacity:.55">${t}</span> ‚Äî <span class="${klass}">${escapeHtml(text)}</span>`;
  ui.log.prepend(span);
  // keep short
  while(ui.log.childNodes.length > 22) ui.log.removeChild(ui.log.lastChild);
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// --------- Œ£-state simulation (cableable)
let state = {
  Sigma: 0.15,         // coherencia Œ£ (0..1)
  dSigma: 0.0,         // dŒ£/dt
  LI: 0.10,            // locking index
  R: 0.20,             // correlation proxy
  dH: 0.00,            // entropy delta
  vetoPass: false,
  mode: 'ESCANEO',     // ESCANEO | NUCLEACION | ALERTA
  shock: 0.0           // temporary injection
};

const KPI = {
  LImin: 0.90,
  Rmin: 0.95,
  dHmax: -0.20
};

function setMode(m){
  state.mode = m;
  ui.stateText.textContent = m;
  ui.badge.classList.remove('warn','bad');
  ui.badge.querySelector('.s').style.background = getComputedStyle(document.documentElement).getPropertyValue('--ok');

  if(m === 'NUCLEACION'){
    ui.badge.classList.add('warn');
    ui.badge.querySelector('.s').style.background = getComputedStyle(document.documentElement).getPropertyValue('--warn');
  }
  if(m === 'ALERTA'){
    ui.badge.classList.add('bad');
    ui.badge.querySelector('.s').style.background = getComputedStyle(document.documentElement).getPropertyValue('--bad');
  }
}

function injectLock(){
  state.shock = 1.0;
  logLine('‚ö° INJECT LOCK: elevando Œ£/LI con ca√≠da ŒîH si sostiene', 'bad');
}
function calm(){
  state.shock = 0.0;
  state.Sigma = 0.12;
  state.LI = 0.08;
  state.R = 0.16;
  state.dH = 0.02;
  setMode('ESCANEO');
  logLine('ü´ß CALMA: restableciendo baseline', 'ok');
}
document.getElementById('btnShock').addEventListener('click', injectLock);
document.getElementById('btnCalm').addEventListener('click', calm);

// --------- Particles (v√©rtigo)
const particles = [];
function spawnParticles(n=120){
  particles.length = 0;
  for(let i=0;i<n;i++){
    particles.push({
      ang: Math.random()*Math.PI*2,
      rad: 0.10 + Math.random()*0.90,
      vel: (Math.random()*0.6+0.3) * (Math.random()<0.5?-1:1),
      z: Math.random(),
      w: 0.6 + Math.random()*1.8
    });
  }
}
spawnParticles(140);

// --------- Clock helpers
function fmtTime(d){
  const h = String(d.getHours()).padStart(2,'0');
  const m = String(d.getMinutes()).padStart(2,'0');
  const s = String(d.getSeconds()).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// --------- ‚ÄúCausal time‚Äù mapping (tC)
function computeTC(){
  // tC = dŒ£/dt (scaled); we display in "s_Œ£ / s"
  // Here, we take derivative proxy already computed and amplify for readability.
  const tc = state.dSigma * 10.0; // scale for HUD
  return tc;
}

// --------- Simulation step
let lastT = performance.now();
function stepSim(now){
  const dt = Math.max(0.001, Math.min(0.05, (now-lastT)/1000));
  lastT = now;

  // baseline drift
  const base = 0.10 + 0.05*Math.sin(now*0.00025);

  // shock decays slowly unless auto keeps it alive
  if(state.shock > 0){
    // approach high-coherence regime
    state.Sigma += (0.85 - state.Sigma) * (0.55*dt) * (0.75 + 0.50*state.shock);
    state.LI    += (0.97 - state.LI)    * (0.95*dt) * (0.70 + 0.50*state.shock);
    state.R     += (0.985 - state.R)    * (0.80*dt) * (0.60 + 0.50*state.shock);

    // enforce entropy drop if Sigma sustains
    const targetdH = (-0.28 - 0.18*Math.sin(now*0.0012)) * (0.65 + 0.35*state.shock);
    state.dH += (targetdH - state.dH) * (0.65*dt);

    // decay shock
    state.shock = Math.max(0, state.shock - 0.10*dt);
  } else {
    // return to baseline
    state.Sigma += (base - state.Sigma) * (0.35*dt);
    state.LI    += (0.08 - state.LI)    * (0.45*dt);
    state.R     += (0.14 - state.R)     * (0.40*dt);
    state.dH    += (0.02 - state.dH)    * (0.60*dt);

    // occasional micro-spikes if auto
    if(toggles.auto && Math.random() < 0.010){
      state.Sigma += 0.08*Math.random();
      state.LI += 0.05*Math.random();
      state.R += 0.06*Math.random();
      state.dH += 0.03*Math.random();
    }
  }

  // derivative proxy
  const prevSigma = state.Sigma;
  // tiny noise
  state.Sigma = clamp(state.Sigma + (Math.random()-0.5)*0.002, 0, 1);
  state.dSigma = (state.Sigma - prevSigma)/dt;

  // decision logic (E-Veto)
  const sigmaOK = (state.LI >= KPI.LImin) && (state.R >= KPI.Rmin);
  const vetoOK  = (state.dH <= KPI.dHmax);
  state.vetoPass = sigmaOK && vetoOK;

  // mode changes
  if(state.LI > 0.60 && state.R > 0.70) setMode('NUCLEACION');
  if(state.vetoPass) setMode('ALERTA');
  if(state.LI < 0.35 && state.R < 0.45 && !state.vetoPass) setMode('ESCANEO');

  // log significant transitions
  if(state.vetoPass && Math.random() < 0.03){
    logLine(`‚úÖ PASS: LI=${state.LI.toFixed(2)} R=${state.R.toFixed(2)} ŒîH=${state.dH.toFixed(2)}`, 'ok');
  } else if (!vetoOK && sigmaOK && Math.random() < 0.02){
    logLine(`‚õî E-VETO: coherente sin ca√≠da ŒîH (${state.dH.toFixed(2)} > ${KPI.dHmax})`, 'bad');
  }
}

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

// --------- Tesseract data
const tesseractVertices = [];
for (let x = -1; x <= 1; x += 2) {
  for (let y = -1; y <= 1; y += 2) {
    for (let z = -1; z <= 1; z += 2) {
      for (let w = -1; w <= 1; w += 2) {
        tesseractVertices.push([x, y, z, w]);
      }
    }
  }
}

const tesseractEdges = [];
for (let i = 0; i < tesseractVertices.length; i++) {
  for (let j = i + 1; j < tesseractVertices.length; j++) {
    let diffCount = 0;
    for (let k = 0; k < 4; k++) {
      if (tesseractVertices[i][k] !== tesseractVertices[j][k]) diffCount++;
    }
    if (diffCount === 1) {
      tesseractEdges.push([i, j]);
    }
  }
}

// --------- Rotation matrices
function rotate4D(point, angleXW, angleYW, angleZW) {
  const cosXW = Math.cos(angleXW);
  const sinXW = Math.sin(angleXW);
  const cosYW = Math.cos(angleYW);
  const sinYW = Math.sin(angleYW);
  const cosZW = Math.cos(angleZW);
  const sinZW = Math.sin(angleZW);

  let [x, y, z, w] = point;

  // Rotate XW
  let tempX = x * cosXW - w * sinXW;
  let tempW = x * sinXW + w * cosXW;
  x = tempX;
  w = tempW;

  // Rotate YW
  let tempY = y * cosYW - w * sinYW;
  tempW = y * sinYW + w * cosYW;
  y = tempY;
  w = tempW;

  // Rotate ZW
  let tempZ = z * cosZW - w * sinZW;
  tempW = z * sinZW + w * cosZW;
  z = tempZ;
  w = tempW;

  return [x, y, z, w];
}

// --------- Project 4D to 3D
function project4DTo3D(point, dist4D = 2) {
  const [x, y, z, w] = point;
  const factor = dist4D / (dist4D - w);
  return [x * factor, y * factor, z * factor];
}

// --------- Project 3D to 2D
function project3DTo2D(point, dist3D = 4) {
  const [x, y, z] = point;
  const factor = dist3D / (dist3D - z);
  return [x * factor, y * factor];
}

// --------- Render
function draw(now){
  stepSim(now);

  const w = canvas.width;
  const h = canvas.height;
  const cx = w * 0.5;
  const cy = h * 0.5;
  const scale = Math.min(w, h) * 0.2;

  ctx.clearRect(0,0,w,h);

  // soft vignette
  ctx.save();
  const vg = ctx.createRadialGradient(cx,cy,scale*0.2,cx,cy,scale*1.65);
  vg.addColorStop(0, 'rgba(0,0,0,0)');
  vg.addColorStop(1, 'rgba(0,0,0,0.55)');
  ctx.fillStyle = vg;
  ctx.fillRect(0,0,w,h);
  ctx.restore();

  // warp background (adapted for tesseract distortion)
  const warp = toggles.warp ? (0.40 + 0.75 * Math.max(0, state.Sigma)) : 0.0;
  const dist4D = 2 + warp * 2; // Distort projection based on warp

  // Rotate angles based on time and Sigma, using controllable speeds
  const t = now * 0.001;
  const angleXW = t * rotationSpeeds.xw * 1000 + state.Sigma * 2; // Multiply t by 1000 if speeds are small
  const angleYW = t * rotationSpeeds.yw * 1000 + state.LI * 2;
  const angleZW = t * rotationSpeeds.zw * 1000 + state.R * 2;

  // Project vertices
  const projectedVertices = tesseractVertices.map(v => {
    const rotated = rotate4D(v, angleXW, angleYW, angleZW);
    const proj3D = project4DTo3D(rotated, dist4D);
    const proj2D = project3DTo2D(proj3D);
    return [cx + proj2D[0] * scale, cy + proj2D[1] * scale];
  });

  // Draw edges
  ctx.save();
  ctx.strokeStyle = `rgba(145,255,224,${0.3 + 0.4 * state.Sigma})`;
  ctx.lineWidth = 1.5 * DPR;
  ctx.globalCompositeOperation = 'lighter';
  for (const [i, j] of tesseractEdges) {
    const [x1, y1] = projectedVertices[i];
    const [x2, y2] = projectedVertices[j];
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }
  ctx.restore();

  // particles along edges or vertices
  if(toggles.particles){
    drawParticlesOnTesseract(projectedVertices, now, warp);
  }

  // center glow adapted
  drawCore(cx, cy, scale, now);

  // HUD update
  const d = new Date();
  ui.tmLabel.textContent = d.toDateString();
  ui.tmBig.textContent = fmtTime(d);

  const tc = computeTC();
  ui.tcBig.textContent = (tc>=0?'+':'') + tc.toFixed(3);

  ui.liVal.textContent = state.LI.toFixed(3);
  ui.rVal.textContent  = state.R.toFixed(3);
  ui.dhVal.textContent = state.dH.toFixed(3);
  ui.vetoVal.textContent = state.vetoPass ? 'PASS' : 'HOLD/FAIL';

  requestAnimationFrame(draw);
}

function drawParticlesOnTesseract(vertices, now, warp){
  const t = now*0.001;
  ctx.save();
  ctx.globalCompositeOperation = 'lighter';

  for(let i = 0; i < vertices.length; i++){
    const [x, y] = vertices[i];
    const alpha = 0.1 + 0.3 * Math.sin(t + i);
    const size = (1.5 + 2.5 * warp) * DPR;

    ctx.beginPath();
    ctx.fillStyle = `rgba(145,255,224,${alpha * 0.55})`;
    ctx.arc(x, y, size, 0, Math.PI*2);
    ctx.fill();

    ctx.beginPath();
    ctx.fillStyle = `rgba(119,166,255,${alpha * 0.40})`;
    ctx.arc(x + Math.sin(t + i) * 2, y + Math.cos(t + i) * 2, size * 0.65, 0, Math.PI*2);
    ctx.fill();
  }

  ctx.restore();
}

function drawCore(cx,cy,R, now){
  const t = now*0.001;

  // glow
  ctx.save();
  ctx.globalCompositeOperation='lighter';
  const g = ctx.createRadialGradient(cx,cy,0,cx,cy,R*0.22);
  g.addColorStop(0, `rgba(145,255,224,${0.20+0.25*state.Sigma})`);
  g.addColorStop(0.55, `rgba(119,166,255,${0.10+0.15*state.Sigma})`);
  g.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle=g;
  ctx.beginPath();
  ctx.arc(cx,cy,R*0.22,0,Math.PI*2);
  ctx.fill();
  ctx.restore();

  // core ring
  ring(cx,cy,R*0.10, 2.0*DPR, `rgba(255,255,255,0.16)`);

  // center dot
  ctx.beginPath();
  ctx.fillStyle = 'rgba(255,255,255,0.22)';
  ctx.arc(cx,cy, 3.2*DPR, 0, Math.PI*2);
  ctx.fill();

  // small ‚Äúbreathing‚Äù notch
  ctx.save();
  ctx.translate(cx,cy);
  const a = t*1.4;
  ctx.beginPath();
  ctx.strokeStyle = `rgba(145,255,224,${0.18+0.20*state.Sigma})`;
  ctx.lineWidth = 2.0*DPR;
  ctx.arc(0,0, R*0.14, a, a + Math.PI*0.75);
  ctx.stroke();
  ctx.restore();
}

// primitives
function ring(cx,cy,r, lw, col){
  ctx.beginPath();
  ctx.lineWidth = lw;
  ctx.strokeStyle = col;
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.stroke();
}

// initial log
logLine('üëÅÔ∏è Reloj Causal Tesseract online. Modo: simulaci√≥n hiperdimensional.', 'ok');
logLine('Tip: presiona INJECT LOCK para ver la rotaci√≥n causal en 4D.', 'warn');

requestAnimationFrame(draw);
</script>
</body>
</html>
