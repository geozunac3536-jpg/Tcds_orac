<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TCDS ‚Äî Reloj Causal</title>
  <meta name="description" content="Reloj Causal TCDS: tiempo normal vs tiempo causal, coherencia Œ£ y veto entr√≥pico en vivo." />
  <meta name="theme-color" content="#070a10" />

  <style>
    :root{
      --bg:#06070b;
      --bg2:#0b1020;
      --txt:#eaf0ff;
      --mut: rgba(234,240,255,.72);
      --dim: rgba(234,240,255,.55);
      --stroke: rgba(255,255,255,.12);
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.035);
      --accent:#77a6ff;
      --a2:#91ffe0;
      --warn:#ffd37a;
      --ok:#8effa1;
      --bad:#ff7aa2;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --r: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family:var(--sans);
      background:
        radial-gradient(1200px 900px at 12% -12%, rgba(119,166,255,.22), transparent 60%),
        radial-gradient(1100px 800px at 88% 8%, rgba(145,255,224,.16), transparent 58%),
        radial-gradient(900px 700px at 55% 112%, rgba(255,122,162,.10), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:34px 18px 90px}

    header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;
      padding:18px 18px;
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .brand{display:flex;gap:14px;align-items:center}
    .sig{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(119,166,255,.95), rgba(145,255,224,.55) 44%, rgba(255,255,255,.07) 72%);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 0 7px rgba(119,166,255,.08);
      position:relative;
    }
    .sig:after{
      content:"";
      position:absolute;inset:-22px;
      background: radial-gradient(circle, rgba(119,166,255,.12), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
    }

    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--mut);font-size:13px;line-height:1.35}

    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      display:inline-flex;gap:8px;align-items:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color:var(--txt);text-decoration:none;font-size:13px;
      transition: transform .15s ease, background .15s ease, border .15s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px);background: rgba(255,255,255,.07);border-color: rgba(255,255,255,.22)}
    .btn .dot{width:8px;height:8px;border-radius:99px;background:var(--accent)}
    .btn.small{padding:8px 10px;border-radius:999px;font-family:var(--mono);font-size:12px}

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      align-items:stretch;
    }
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column;align-items:stretch}
      .nav{justify-content:flex-start}
    }

    .card{
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .clockWrap{
      position:relative;
      min-height:520px;
    }
    @media(max-width:980px){
      .clockWrap{min-height:520px}
    }

    canvas#clock{
      width:100%;
      height:100%;
      display:block;
    }

    .overlay{
      position:absolute;inset:0;
      pointer-events:none;
      padding:18px;
      display:flex;flex-direction:column;justify-content:space-between;
    }

    .kicker{
      pointer-events:none;
      display:inline-flex;gap:10px;align-items:center;
      font-family:var(--mono);font-size:12px;color:var(--dim);
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      width:max-content;
    }
    .kicker .pulse{
      width:10px;height:10px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, var(--a2), rgba(145,255,224,.2) 60%, transparent 72%);
      box-shadow: 0 0 0 7px rgba(145,255,224,.08);
    }

    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    @media(max-width:620px){ .hud{grid-template-columns:1fr} }

    .panel{
      pointer-events:auto;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }

    .row{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .lab{font-family:var(--mono);font-size:12px;color:var(--dim)}
    .val{font-family:var(--mono);font-size:12px;color:var(--txt)}
    .big{
      margin-top:8px;
      font-size:28px;
      letter-spacing:.2px;
      font-weight:650;
      font-family:var(--mono);
    }
    .badge{
      display:inline-flex;gap:8px;align-items:center;
      font-family:var(--mono);font-size:12px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      margin-top:10px;
      width:max-content;
    }
    .badge .s{width:9px;height:9px;border-radius:99px;background:var(--ok)}
    .badge.warn .s{background:var(--warn)}
    .badge.bad .s{background:var(--bad)}

    .side{
      padding:16px;
    }

    .side h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
      color:rgba(234,240,255,.92);
    }

    .tiles{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .tile{
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }
    .tile p{margin:0;color:var(--mut);font-size:13px;line-height:1.5}
    .tagrow{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .tag{
      font-family:var(--mono);
      font-size:12px;color:rgba(234,240,255,.76);
      padding:7px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }

    .controls{
      display:flex;gap:10px;flex-wrap:wrap;
      margin-top:12px;
    }
    .switch{
      pointer-events:auto;
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      font-family:var(--mono);font-size:12px;color:rgba(234,240,255,.8);
      user-select:none;
      cursor:pointer;
    }
    .knob{
      width:38px;height:20px;border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      position:relative;
    }
    .knob:after{
      content:"";
      position:absolute;top:1px;left:2px;
      width:16px;height:16px;border-radius:99px;
      background: rgba(234,240,255,.85);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      transition: transform .18s ease, background .18s ease;
    }
    .switch.on .knob{background: rgba(145,255,224,.15);border-color: rgba(145,255,224,.26)}
    .switch.on .knob:after{transform: translateX(18px);background: rgba(145,255,224,.9)}

    .log{
      margin-top:12px;
      font-family:var(--mono);
      font-size:12px;
      color:rgba(234,240,255,.75);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:12px;
      max-height:210px;
      overflow:auto;
      line-height:1.55;
    }
    .log .ok{color:rgba(142,255,161,.95)}
    .log .bad{color:rgba(255,122,162,.95)}
    .log .warn{color:rgba(255,211,122,.95)}

    footer{
      margin-top:16px;
      color:var(--dim);
      font-size:12px;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;
    }
    .sep{opacity:.35}
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="brand">
        <div class="sig" aria-hidden="true"></div>
        <div>
          <h1>TCDS ‚Äî Reloj Causal</h1>
          <div class="sub">Tiempo normal <span class="sep">¬∑</span> Tiempo causal <span class="sep">¬∑</span> coherencia Œ£ y veto entr√≥pico (ŒîH) en vivo</div>
        </div>
      </div>

      <nav class="nav">
        <a class="btn" href="./"><span class="dot"></span>Home</a>
        <a class="btn" href="./docs/"><span class="dot" style="background:var(--a2)"></span>Docs</a>
        <a class="btn" href="https://github.com/geozunac3536-jpg" target="_blank" rel="noopener">
          <span class="dot" style="background:var(--warn)"></span>GitHub
        </a>
        <a class="btn" href="mailto:genarocarrasco.ozuna@gmail.com"><span class="dot" style="background:var(--ok)"></span>Contacto</a>
      </nav>
    </header>

    <div class="grid">

      <!-- CLOCK -->
      <section class="card clockWrap">
        <canvas id="clock"></canvas>

        <div class="overlay">
          <div class="kicker"><span class="pulse"></span> Q¬∑Œ£ = œÜ ¬∑ reloj causal con ‚Äúwarp‚Äù coherencial</div>

          <div class="hud">
            <div class="panel">
              <div class="row">
                <div class="lab">tM (tiempo est√°ndar)</div>
                <div class="val" id="tmLabel">‚Äî</div>
              </div>
              <div class="big" id="tmBig">--:--:--</div>
              <div class="badge" id="stateBadge"><span class="s"></span><span id="stateText">ESCANEO</span></div>
            </div>

            <div class="panel">
              <div class="row">
                <div class="lab">tC (tiempo causal)</div>
                <div class="val" id="tcLabel">dŒ£/dt</div>
              </div>
              <div class="big" id="tcBig">0.000</div>
              <div class="row" style="margin-top:6px">
                <div class="lab">LI</div><div class="val" id="liVal">0.000</div>
              </div>
              <div class="row">
                <div class="lab">R</div><div class="val" id="rVal">0.000</div>
              </div>
              <div class="row">
                <div class="lab">ŒîH</div><div class="val" id="dhVal">0.000</div>
              </div>
              <div class="row">
                <div class="lab">E-Veto</div><div class="val" id="vetoVal">‚Äî</div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- SIDE -->
      <aside class="card side">
        <h2>Panel de Control</h2>

        <div class="tiles">
          <div class="tile">
            <p>
              Esto es un <b>front-end</b> del Reloj Causal. Ahora est√° en modo
              <b>simulaci√≥n elegante</b> (para v√©rtigo). Lo puedes cablear a:
              <span class="tagrow">
                <span class="tag">outbox/*.json</span>
                <span class="tag">events_feed.jsonl</span>
                <span class="tag">oracle_decisions</span>
              </span>
            </p>

            <div class="controls">
              <div class="switch on" id="swWarp"><div class="knob"></div>WARP</div>
              <div class="switch on" id="swParticles"><div class="knob"></div>PART√çCULAS</div>
              <div class="switch on" id="swAuto"><div class="knob"></div>AUTO-ESCANEO</div>
              <a class="btn small" id="btnShock" href="javascript:void(0)"><span class="dot" style="background:var(--bad)"></span>INJECT LOCK</a>
              <a class="btn small" id="btnCalm" href="javascript:void(0)"><span class="dot" style="background:var(--a2)"></span>CALMA</a>
            </div>
          </div>

          <div class="tile">
            <h2 style="margin:0 0 10px;font-size:14px">Registro</h2>
            <div class="log" id="log"></div>
          </div>

          <div class="tile">
            <p>
              <b>Lectura:</b> tC no es ‚Äúotra hora‚Äù; es un <b>gradiente</b> (dŒ£/dt).
              Cuando el sistema entra en locking y ŒîH cae, el reloj <b>se adelanta</b>:
              el futuro deja de ser conjetura y se vuelve geometr√≠a operable.
            </p>
          </div>
        </div>

        <footer>
          <div>¬© TCDS ‚Äî Cromodin√°mica Sincr√≥nica</div>
          <div class="sep">‚Äî</div>
          <div style="font-family:var(--mono)">Genaro Carrasco Ozuna ¬∑ MX</div>
        </footer>

      </aside>
    </div>

  </div>

<script>
/* ============================================================
   TCDS CAUSAL CLOCK ‚Äî ‚ÄúMEGALUJO V√âRTIGO‚Äù
   - Canvas clock: rings + warp + particles
   - Live HUD: tM, tC, LI, R, dH, E-Veto
   - Simulation baseline (cableable a datos reales)
   ============================================================ */

const canvas = document.getElementById('clock');
const ctx = canvas.getContext('2d', { alpha: true });

const ui = {
  tmLabel: document.getElementById('tmLabel'),
  tmBig: document.getElementById('tmBig'),
  tcBig: document.getElementById('tcBig'),
  liVal: document.getElementById('liVal'),
  rVal: document.getElementById('rVal'),
  dhVal: document.getElementById('dhVal'),
  vetoVal: document.getElementById('vetoVal'),
  badge: document.getElementById('stateBadge'),
  stateText: document.getElementById('stateText'),
  log: document.getElementById('log')
};

let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function resize(){
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * DPR);
  canvas.height = Math.floor(rect.height * DPR);
}
window.addEventListener('resize', () => { resize(); });
resize();

// --------- Toggles
const toggles = {
  warp: true,
  particles: true,
  auto: true
};
function bindSwitch(id, key){
  const el = document.getElementById(id);
  el.addEventListener('click', () => {
    toggles[key] = !toggles[key];
    el.classList.toggle('on', toggles[key]);
    logLine(`‚öôÔ∏è ${key.toUpperCase()} = ${toggles[key] ? 'ON' : 'OFF'}`, 'warn');
  });
}
bindSwitch('swWarp','warp');
bindSwitch('swParticles','particles');
bindSwitch('swAuto','auto');

// --------- Log
function logLine(text, klass=''){
  const t = new Date().toLocaleTimeString();
  const span = document.createElement('div');
  span.innerHTML = `<span style="opacity:.55">${t}</span> ‚Äî <span class="${klass}">${escapeHtml(text)}</span>`;
  ui.log.prepend(span);
  // keep short
  while(ui.log.childNodes.length > 22) ui.log.removeChild(ui.log.lastChild);
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// --------- Œ£-state simulation (cableable)
let state = {
  Sigma: 0.15,         // coherencia Œ£ (0..1)
  dSigma: 0.0,         // dŒ£/dt
  LI: 0.10,            // locking index
  R: 0.20,             // correlation proxy
  dH: 0.00,            // entropy delta
  vetoPass: false,
  mode: 'ESCANEO',     // ESCANEO | NUCLEACION | ALERTA
  shock: 0.0           // temporary injection
};

const KPI = {
  LImin: 0.90,
  Rmin: 0.95,
  dHmax: -0.20
};

function setMode(m){
  state.mode = m;
  ui.stateText.textContent = m;
  ui.badge.classList.remove('warn','bad');
  ui.badge.querySelector('.s').style.background = getComputedStyle(document.documentElement).getPropertyValue('--ok');

  if(m === 'NUCLEACION'){
    ui.badge.classList.add('warn');
    ui.badge.querySelector('.s').style.background = getComputedStyle(document.documentElement).getPropertyValue('--warn');
  }
  if(m === 'ALERTA'){
    ui.badge.classList.add('bad');
    ui.badge.querySelector('.s').style.background = getComputedStyle(document.documentElement).getPropertyValue('--bad');
  }
}

function injectLock(){
  state.shock = 1.0;
  logLine('‚ö° INJECT LOCK: elevando Œ£/LI con ca√≠da ŒîH si sostiene', 'bad');
}
function calm(){
  state.shock = 0.0;
  state.Sigma = 0.12;
  state.LI = 0.08;
  state.R = 0.16;
  state.dH = 0.02;
  setMode('ESCANEO');
  logLine('ü´ß CALMA: restableciendo baseline', 'ok');
}
document.getElementById('btnShock').addEventListener('click', injectLock);
document.getElementById('btnCalm').addEventListener('click', calm);

// --------- Particles (v√©rtigo)
const particles = [];
function spawnParticles(n=120){
  particles.length = 0;
  for(let i=0;i<n;i++){
    particles.push({
      ang: Math.random()*Math.PI*2,
      rad: 0.10 + Math.random()*0.90,
      vel: (Math.random()*0.6+0.3) * (Math.random()<0.5?-1:1),
      z: Math.random(),
      w: 0.6 + Math.random()*1.8
    });
  }
}
spawnParticles(140);

// --------- Clock helpers
function fmtTime(d){
  const h = String(d.getHours()).padStart(2,'0');
  const m = String(d.getMinutes()).padStart(2,'0');
  const s = String(d.getSeconds()).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// --------- ‚ÄúCausal time‚Äù mapping (tC)
function computeTC(){
  // tC = dŒ£/dt (scaled); we display in "s_Œ£ / s"
  // Here, we take derivative proxy already computed and amplify for readability.
  const tc = state.dSigma * 10.0; // scale for HUD
  return tc;
}

// --------- Simulation step
let lastT = performance.now();
function stepSim(now){
  const dt = Math.max(0.001, Math.min(0.05, (now-lastT)/1000));
  lastT = now;

  // baseline drift
  const base = 0.10 + 0.05*Math.sin(now*0.00025);

  // shock decays slowly unless auto keeps it alive
  if(state.shock > 0){
    // approach high-coherence regime
    state.Sigma += (0.85 - state.Sigma) * (0.55*dt) * (0.75 + 0.50*state.shock);
    state.LI    += (0.97 - state.LI)    * (0.95*dt) * (0.70 + 0.50*state.shock);
    state.R     += (0.985 - state.R)    * (0.80*dt) * (0.60 + 0.50*state.shock);

    // enforce entropy drop if Sigma sustains
    const targetdH = (-0.28 - 0.18*Math.sin(now*0.0012)) * (0.65 + 0.35*state.shock);
    state.dH += (targetdH - state.dH) * (0.65*dt);

    // decay shock
    state.shock = Math.max(0, state.shock - 0.10*dt);
  } else {
    // return to baseline
    state.Sigma += (base - state.Sigma) * (0.35*dt);
    state.LI    += (0.08 - state.LI)    * (0.45*dt);
    state.R     += (0.14 - state.R)     * (0.40*dt);
    state.dH    += (0.02 - state.dH)    * (0.60*dt);

    // occasional micro-spikes if auto
    if(toggles.auto && Math.random() < 0.010){
      state.Sigma += 0.08*Math.random();
      state.LI += 0.05*Math.random();
      state.R += 0.06*Math.random();
      state.dH += 0.03*Math.random();
    }
  }

  // derivative proxy
  const prevSigma = state.Sigma;
  // tiny noise
  state.Sigma = clamp(state.Sigma + (Math.random()-0.5)*0.002, 0, 1);
  state.dSigma = (state.Sigma - prevSigma)/dt;

  // decision logic (E-Veto)
  const sigmaOK = (state.LI >= KPI.LImin) && (state.R >= KPI.Rmin);
  const vetoOK  = (state.dH <= KPI.dHmax);
  state.vetoPass = sigmaOK && vetoOK;

  // mode changes
  if(state.LI > 0.60 && state.R > 0.70) setMode('NUCLEACION');
  if(state.vetoPass) setMode('ALERTA');
  if(state.LI < 0.35 && state.R < 0.45 && !state.vetoPass) setMode('ESCANEO');

  // log significant transitions
  if(state.vetoPass && Math.random() < 0.03){
    logLine(`‚úÖ PASS: LI=${state.LI.toFixed(2)} R=${state.R.toFixed(2)} ŒîH=${state.dH.toFixed(2)}`, 'ok');
  } else if (!vetoOK && sigmaOK && Math.random() < 0.02){
    logLine(`‚õî E-VETO: coherente sin ca√≠da ŒîH (${state.dH.toFixed(2)} > ${KPI.dHmax})`, 'bad');
  }
}

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

// --------- Render
function draw(now){
  stepSim(now);

  const w = canvas.width;
  const h = canvas.height;
  const cx = w*0.5;
  const cy = h*0.5;
  const R = Math.min(w,h) * 0.34;

  ctx.clearRect(0,0,w,h);

  // soft vignette
  ctx.save();
  const vg = ctx.createRadialGradient(cx,cy,R*0.2,cx,cy,R*1.65);
  vg.addColorStop(0, 'rgba(0,0,0,0)');
  vg.addColorStop(1, 'rgba(0,0,0,0.55)');
  ctx.fillStyle = vg;
  ctx.fillRect(0,0,w,h);
  ctx.restore();

  // warp background rings
  const warp = toggles.warp ? (0.40 + 0.75*Math.max(0, state.Sigma)) : 0.0;
  drawWarp(cx,cy,R, now, warp);

  // particles
  if(toggles.particles){
    drawParticles(cx,cy,R, now, warp);
  }

  // main clock rings
  drawRings(cx,cy,R, now);

  // hands: tM, tC
  drawHands(cx,cy,R, now);

  // center glow
  drawCore(cx,cy,R, now);

  // HUD update
  const d = new Date();
  ui.tmLabel.textContent = d.toDateString();
  ui.tmBig.textContent = fmtTime(d);

  const tc = computeTC();
  ui.tcBig.textContent = (tc>=0?'+':'') + tc.toFixed(3);

  ui.liVal.textContent = state.LI.toFixed(3);
  ui.rVal.textContent  = state.R.toFixed(3);
  ui.dhVal.textContent = state.dH.toFixed(3);
  ui.vetoVal.textContent = state.vetoPass ? 'PASS' : 'HOLD/FAIL';

  requestAnimationFrame(draw);
}

function drawWarp(cx,cy,R, now, warp){
  const t = now*0.001;
  const layers = 16;
  for(let i=0;i<layers;i++){
    const k = i/(layers-1);
    const rr = R*(0.55 + 1.05*k);
    const wob = (Math.sin(t*1.1 + i*0.6)*0.5 + Math.sin(t*0.7 + i*0.35))*0.5;
    const a = 0.055 * (1-k) * (0.6 + warp) ;
    ctx.beginPath();
    ctx.lineWidth = Math.max(1, (1.2 - k)*DPR);
    ctx.strokeStyle = `rgba(119,166,255,${a*0.85})`;
    ctx.arc(cx,cy, rr + wob*R*0.03*(0.2+warp), 0, Math.PI*2);
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = `rgba(145,255,224,${a*0.65})`;
    ctx.arc(cx,cy, rr*0.93 + wob*R*0.02*(0.2+warp), 0, Math.PI*2);
    ctx.stroke();
  }
}

function drawParticles(cx,cy,R, now, warp){
  const t = now*0.001;
  ctx.save();
  ctx.globalCompositeOperation = 'lighter';

  for(const p of particles){
    // spiral motion
    p.ang += p.vel * 0.006 * (0.25 + warp);
    const rad = (0.12 + p.rad) * (R*1.35);
    const swirl = Math.sin(t*1.2 + p.rad*9.0) * (R*0.04) * (0.25+warp);
    const x = cx + Math.cos(p.ang) * (rad + swirl);
    const y = cy + Math.sin(p.ang) * (rad + swirl);

    const alpha = 0.06 + 0.18*(1-p.rad) + 0.12*Math.max(0,state.Sigma);
    const size = (0.9 + p.w) * (0.9 + 1.7*(1-p.rad)) * DPR;

    ctx.beginPath();
    ctx.fillStyle = `rgba(145,255,224,${alpha*0.55})`;
    ctx.arc(x,y,size,0,Math.PI*2);
    ctx.fill();

    ctx.beginPath();
    ctx.fillStyle = `rgba(119,166,255,${alpha*0.40})`;
    ctx.arc(x+Math.sin(p.ang)*1.2, y-Math.cos(p.ang)*1.2, size*0.65, 0, Math.PI*2);
    ctx.fill();
  }

  ctx.restore();
}

function drawRings(cx,cy,R, now){
  const t = now*0.001;
  // outer halo
  ring(cx,cy,R*1.10, 2.0, `rgba(255,255,255,0.08)`);
  ring(cx,cy,R*1.03, 1.2, `rgba(255,255,255,0.10)`);

  // coherence ring (thickness depends on Sigma)
  const thick = (2.0 + 6.0*state.Sigma) * DPR;
  ring(cx,cy,R*0.82, thick, `rgba(145,255,224,${0.16+0.24*state.Sigma})`);

  // entropy ring (color depends on dH)
  const ok = state.dH <= -0.20;
  ring(cx,cy,R*0.68, 2.0*DPR, ok ? `rgba(142,255,161,0.20)` : `rgba(255,122,162,0.18)`);

  // ticks
  ctx.save();
  ctx.translate(cx,cy);
  for(let i=0;i<120;i++){
    const a = (i/120)*Math.PI*2;
    const major = (i%10===0);
    const len = (major ? 12 : 6) * DPR;
    const rr1 = R*0.96;
    const rr2 = rr1 - len;
    ctx.beginPath();
    ctx.lineWidth = (major ? 1.2 : 0.9) * DPR;
    ctx.strokeStyle = major ? `rgba(255,255,255,0.15)` : `rgba(255,255,255,0.08)`;
    ctx.moveTo(Math.cos(a)*rr1, Math.sin(a)*rr1);
    ctx.lineTo(Math.cos(a)*rr2, Math.sin(a)*rr2);
    ctx.stroke();
  }
  ctx.restore();

  // subtle orbit arcs
  ctx.save();
  ctx.globalAlpha = 0.7;
  ctx.globalCompositeOperation = 'lighter';
  arc(cx,cy,R*0.92, t*0.35, t*0.35 + Math.PI*1.2, `rgba(119,166,255,0.11)`, 2.0*DPR);
  arc(cx,cy,R*0.75, -t*0.42, -t*0.42 + Math.PI*0.9, `rgba(145,255,224,0.10)`, 2.0*DPR);
  ctx.restore();
}

function drawHands(cx,cy,R, now){
  const d = new Date();
  const sec = d.getSeconds() + d.getMilliseconds()/1000;
  const min = d.getMinutes() + sec/60;
  const hr  = (d.getHours()%12) + min/60;

  // tM hands
  const aS = (sec/60)*Math.PI*2 - Math.PI/2;
  const aM = (min/60)*Math.PI*2 - Math.PI/2;
  const aH = (hr/12)*Math.PI*2 - Math.PI/2;

  // tC hand: phase lead based on Sigma and dH
  // more Sigma + more negative dH => lead
  const lead = clamp(0.10 + 0.85*state.Sigma + 0.35*clamp((-state.dH),0,0.6), 0, 1.4);
  const aC = aM + lead*0.55; // offset from minute hand for ‚Äúv√©rtigo‚Äù

  // draw
  hand(cx,cy,aH, R*0.48, 3.2*DPR, `rgba(255,255,255,0.22)`);
  hand(cx,cy,aM, R*0.62, 2.5*DPR, `rgba(255,255,255,0.20)`);
  hand(cx,cy,aS, R*0.70, 1.6*DPR, `rgba(255,255,255,0.14)`);

  // causal hand (glowing)
  ctx.save();
  ctx.globalCompositeOperation='lighter';
  hand(cx,cy,aC, R*0.74, (2.8+2.2*state.Sigma)*DPR, `rgba(145,255,224,${0.18+0.22*state.Sigma})`);
  hand(cx,cy,aC, R*0.58, (1.2+1.0*state.Sigma)*DPR, `rgba(119,166,255,${0.12+0.18*state.Sigma})`);
  ctx.restore();
}

function drawCore(cx,cy,R, now){
  const t = now*0.001;

  // glow
  ctx.save();
  ctx.globalCompositeOperation='lighter';
  const g = ctx.createRadialGradient(cx,cy,0,cx,cy,R*0.22);
  g.addColorStop(0, `rgba(145,255,224,${0.20+0.25*state.Sigma})`);
  g.addColorStop(0.55, `rgba(119,166,255,${0.10+0.15*state.Sigma})`);
  g.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle=g;
  ctx.beginPath();
  ctx.arc(cx,cy,R*0.22,0,Math.PI*2);
  ctx.fill();
  ctx.restore();

  // core ring
  ring(cx,cy,R*0.10, 2.0*DPR, `rgba(255,255,255,0.16)`);

  // center dot
  ctx.beginPath();
  ctx.fillStyle = 'rgba(255,255,255,0.22)';
  ctx.arc(cx,cy, 3.2*DPR, 0, Math.PI*2);
  ctx.fill();

  // small ‚Äúbreathing‚Äù notch
  ctx.save();
  ctx.translate(cx,cy);
  const a = t*1.4;
  ctx.beginPath();
  ctx.strokeStyle = `rgba(145,255,224,${0.18+0.20*state.Sigma})`;
  ctx.lineWidth = 2.0*DPR;
  ctx.arc(0,0, R*0.14, a, a + Math.PI*0.75);
  ctx.stroke();
  ctx.restore();
}

// primitives
function ring(cx,cy,r, lw, col){
  ctx.beginPath();
  ctx.lineWidth = lw;
  ctx.strokeStyle = col;
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.stroke();
}
function arc(cx,cy,r, a0, a1, col, lw){
  ctx.beginPath();
  ctx.strokeStyle = col;
  ctx.lineWidth = lw;
  ctx.lineCap = 'round';
  ctx.arc(cx,cy,r,a0,a1);
  ctx.stroke();
}
function hand(cx,cy, ang, len, lw, col){
  const x = cx + Math.cos(ang)*len;
  const y = cy + Math.sin(ang)*len;

  ctx.beginPath();
  ctx.lineWidth = lw;
  ctx.strokeStyle = col;
  ctx.lineCap = 'round';
  ctx.moveTo(cx,cy);
  ctx.lineTo(x,y);
  ctx.stroke();
}

// initial log
logLine('üëÅÔ∏è Reloj Causal online. Modo: simulaci√≥n elegante.', 'ok');
logLine('Tip: presiona INJECT LOCK para ver el ‚Äúadelanto‚Äù causal.', 'warn');

requestAnimationFrame(draw);
</script>
</body>
</html>
